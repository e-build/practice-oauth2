<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - Shopl B2B SaaS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .user-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff; }
        .info-card h3 { margin-top: 0; color: #007bff; }
        .info-card p { margin: 8px 0; }
        .info-card .label { font-weight: bold; color: #495057; }
        .info-card .value { color: #6c757d; font-family: monospace; }
        .claims-section { margin-top: 20px; }
        .claims-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .claims-table th, .claims-table td { border: 1px solid #dee2e6; padding: 8px; text-align: left; }
        .claims-table th { background-color: #e9ecef; font-weight: bold; }
        .claims-table .claim-key { font-family: monospace; font-weight: bold; color: #007bff; }
        .claims-table .claim-value { font-family: monospace; color: #6c757d; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .logout-btn:hover { background-color: #c82333; }
        .loading { text-align: center; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ Shopl B2B SaaS Dashboard</h1>
            <div id="login_status" class="status loading">ğŸ”„ Checking authentication...</div>
        </div>

        <div id="content" style="display: none;">
            <div class="user-info">
                <div class="info-card">
                    <h3>ğŸ‘¤ ì‚¬ìš©ì ì •ë³´</h3>
                    <p><span class="label">ì‚¬ìš©ìëª…:</span> <span id="username" class="value"></span></p>
                    <p><span class="label">ì´ë©”ì¼:</span> <span id="email" class="value"></span></p>
                    <p><span class="label">ì´ë¦„:</span> <span id="name" class="value"></span></p>
                    <p><span class="label">ì—­í• :</span> <span id="role" class="value"></span></p>
                </div>

                <div class="info-card">
                    <h3>ğŸ¢ Shopl ê³„ì • ì •ë³´</h3>
                    <p><span class="label">Account ID:</span> <span id="account_id" class="value"></span></p>
                    <p><span class="label">Shopl Client ID:</span> <span id="shopl_client_id" class="value"></span></p>
                    <p><span class="label">Shopl User ID:</span> <span id="shopl_user_id" class="value"></span></p>
                    <p><span class="label">User ID:</span> <span id="user_id" class="value"></span></p>
                </div>

                <div class="info-card">
                    <h3>ğŸ” JWT í† í° ì •ë³´</h3>
                    <p><span class="label">Subject (sub):</span> <span id="sub" class="value"></span></p>
                    <p><span class="label">Issuer (iss):</span> <span id="iss" class="value"></span></p>
                    <p><span class="label">Audience (aud):</span> <span id="aud" class="value"></span></p>
                    <p><span class="label">Expires At:</span> <span id="exp" class="value"></span></p>
                    <p><span class="label">Issued At:</span> <span id="iat" class="value"></span></p>
                    <p><span class="label">Scope:</span> <span id="scope" class="value"></span></p>
                </div>

                <div class="info-card">
                    <h3>âš¡ ì„¸ì…˜ ì •ë³´</h3>
                    <p><span class="label">ì¸ì¦ ìƒíƒœ:</span> <span id="authenticated" class="value"></span></p>
                    <p><span class="label">í† í° ì €ì¥ì†Œ:</span> <span class="value">localStorage</span></p>
                    <p><span class="label">í˜„ì¬ ì‹œê°„:</span> <span id="current_time" class="value"></span></p>
                </div>
            </div>

            <div class="claims-section">
                <h3>ğŸ“‹ ëª¨ë“  JWT í´ë ˆì„</h3>
                <table class="claims-table" id="claims_table">
                    <thead>
                        <tr>
                            <th>í´ë ˆì„ í‚¤</th>
                            <th>ê°’</th>
                            <th>íƒ€ì…</th>
                        </tr>
                    </thead>
                    <tbody id="claims_body">
                    </tbody>
                </table>
            </div>
        </div>

        <br/>
        <button id="logout_btn" class="logout-btn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <script>
        const clientId = "oauth2-client";
        const clientSecret = "secret";
        const redirectUri = "http://localhost:9001/dashboard";
        const authServerAuthorizeUrl = "http://localhost:9000/oauth2/authorize";
        const tokenUrl = "http://localhost:9000/oauth2/token";
        const dashboardApiUrl = "http://localhost:9001/api/dashboard"; // API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
        const state = crypto.randomUUID();

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000); // 1ì´ˆë§ˆë‹¤ í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸

        async function fetchToken(code) {
            const body = new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                client_id: clientId,
                client_secret: clientSecret
            });

            try {
                const res = await fetch(tokenUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: body.toString()
                });

                if (!res.ok) throw new Error("Token exchange failed");

                const tokenResponse = await res.json();
                localStorage.setItem("access_token", tokenResponse.access_token);
                localStorage.setItem("refresh_token", tokenResponse.refresh_token);

                await fetchProtectedData();
            } catch (error) {
                setLoginStatus(false, "í† í° êµí™˜ ì‹¤íŒ¨: " + error.message);
            }
        }

        async function fetchProtectedData() {
            const token = localStorage.getItem("access_token");

            if (!token) {
                redirectToAuth();
                return;
            }

            try {
                const res = await fetch(dashboardApiUrl, {
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });

                if (res.status === 401 || res.status === 403) {
                    localStorage.removeItem("access_token");
                    localStorage.removeItem("refresh_token");
                    redirectToAuth();
                    return;
                }

                const data = await res.json();
                
                if (data.authenticated) {
                    setLoginStatus(true, "ë¡œê·¸ì¸ ì„±ê³µ!");
                    populateUserInfo(data);
                    document.getElementById("content").style.display = "block";
                } else {
                    setLoginStatus(false, data.error || "ì¸ì¦ ì‹¤íŒ¨");
                }
            } catch (error) {
                setLoginStatus(false, "API í˜¸ì¶œ ì‹¤íŒ¨: " + error.message);
            }
        }

        function populateUserInfo(data) {
            // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´
            document.getElementById("username").textContent = data.username || 'N/A';
            document.getElementById("email").textContent = data.email || 'N/A';
            document.getElementById("name").textContent = data.name || 'N/A';
            document.getElementById("role").textContent = data.role || 'N/A';

            // Shopl ê³„ì • ì •ë³´
            document.getElementById("account_id").textContent = data.account_id || 'N/A';
            document.getElementById("shopl_client_id").textContent = data.shopl_client_id || 'N/A';
            document.getElementById("shopl_user_id").textContent = data.shopl_user_id || 'N/A';
            document.getElementById("user_id").textContent = data.user_id || 'N/A';

            // JWT í† í° ì •ë³´
            document.getElementById("sub").textContent = data.sub || 'N/A';
            document.getElementById("iss").textContent = data.iss || 'N/A';
            document.getElementById("aud").textContent = Array.isArray(data.aud) ? data.aud.join(', ') : (data.aud || 'N/A');
            document.getElementById("exp").textContent = data.exp ? formatTimestamp(data.exp) : 'N/A';
            document.getElementById("iat").textContent = data.iat ? formatTimestamp(data.iat) : 'N/A';
            document.getElementById("scope").textContent = data.scope || 'N/A';

            // ì„¸ì…˜ ì •ë³´
            document.getElementById("authenticated").textContent = data.authenticated ? 'âœ… ì¸ì¦ë¨' : 'âŒ ë¯¸ì¸ì¦';

            // ëª¨ë“  í´ë ˆì„ í…Œì´ë¸” ìƒì„±
            populateClaimsTable(data.all_claims || {});
        }

        function populateClaimsTable(claims) {
            const tbody = document.getElementById("claims_body");
            tbody.innerHTML = '';

            Object.entries(claims).forEach(([key, value]) => {
                const row = tbody.insertRow();
                row.insertCell(0).innerHTML = `<span class="claim-key">${key}</span>`;
                row.insertCell(1).innerHTML = `<span class="claim-value">${formatClaimValue(value)}</span>`;
                row.insertCell(2).textContent = typeof value;
            });
        }

        function formatClaimValue(value) {
            if (value === null || value === undefined) return 'N/A';
            if (typeof value === 'object') return JSON.stringify(value, null, 2);
            if (typeof value === 'string' && value.length > 100) return value.substring(0, 100) + '...';
            return String(value);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('ko-KR');
        }

        function updateCurrentTime() {
            document.getElementById("current_time").textContent = new Date().toLocaleString('ko-KR');
        }

        function setLoginStatus(success, message) {
            const statusEl = document.getElementById("login_status");
            statusEl.className = `status ${success ? 'success' : 'error'}`;
            statusEl.textContent = `${success ? 'âœ…' : 'âŒ'} ${message}`;
        }

        function redirectToAuth() {
            const params = new URLSearchParams({
                response_type: "code",
                client_id: clientId,
                redirect_uri: redirectUri,
                scope: "openid profile read write",
                state: state
            });

            window.location.href = `${authServerAuthorizeUrl}?${params.toString()}`;
        }

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            window.location.href = "http://localhost:9000/logout";
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("logout_btn").addEventListener("click", logout);

        // ì´ˆê¸° ì‹¤í–‰
        (async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get("code");

            if (code && !localStorage.getItem("access_token")) {
                try {
                    await fetchToken(code);
                    window.history.replaceState({}, document.title, "/dashboard");
                } catch (e) {
                    setLoginStatus(false, "ë¡œê·¸ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    return;
                }
            } else {
                await fetchProtectedData();
            }
        })();
    </script>
</body>
</html>
