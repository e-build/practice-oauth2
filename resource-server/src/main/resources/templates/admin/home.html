<!DOCTYPE html>
<html>
<head>
    <title>Admin Home - Shopl B2B SaaS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .user-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff; }
        .info-card h3 { margin-top: 0; color: #007bff; }
        .info-card p { margin: 8px 0; }
        .info-card .label { font-weight: bold; color: #495057; }
        .info-card .value { color: #6c757d; font-family: monospace; }
        .claims-section { margin-top: 20px; }
        .claims-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .claims-table th, .claims-table td { border: 1px solid #dee2e6; padding: 8px; text-align: left; }
        .claims-table th { background-color: #e9ecef; font-weight: bold; }
        .claims-table .claim-key { font-family: monospace; font-weight: bold; color: #007bff; }
        .claims-table .claim-value { font-family: monospace; color: #6c757d; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .logout-btn:hover { background-color: #c82333; }
        .loading { text-align: center; color: #6c757d; }
        .navigation { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .nav-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; transition: all 0.3s ease; cursor: pointer; }
        .nav-card:hover { background: #e9ecef; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .nav-card .icon { font-size: 48px; margin-bottom: 15px; }
        .nav-card h3 { margin: 0 0 10px 0; color: #495057; }
        .nav-card p { margin: 0; color: #6c757d; font-size: 14px; }
        .stats-section { margin-top: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card .number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-card .label { font-size: 14px; opacity: 0.9; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 14px; transition: all 0.3s ease; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #545b62; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .quick-actions { margin-top: 20px; }
        .quick-actions .btn { margin-right: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ Shopl B2B SaaS Admin Home</h1>
            <div id="login_status" class="status loading">ğŸ”„ Checking authentication...</div>
        </div>

        <div id="content" style="display: none;">
            <div class="user-info">
                <div class="info-card">
                    <h3>ğŸ‘¤ ì‚¬ìš©ì ì •ë³´</h3>
                    <p><span class="label">ì‚¬ìš©ìëª…:</span> <span id="username" class="value"></span></p>
                    <p><span class="label">ì´ë©”ì¼:</span> <span id="email" class="value"></span></p>
                    <p><span class="label">ì´ë¦„:</span> <span id="name" class="value"></span></p>
                    <p><span class="label">ì—­í• :</span> <span id="role" class="value"></span></p>
                </div>

                <div class="info-card">
                    <h3>ğŸ¢ Shopl ê³„ì • ì •ë³´</h3>
                    <p><span class="label">Account ID:</span> <span id="account_id" class="value"></span></p>
                    <p><span class="label">Shopl Client ID:</span> <span id="shopl_client_id" class="value"></span></p>
                    <p><span class="label">Shopl User ID:</span> <span id="shopl_user_id" class="value"></span></p>
                    <p><span class="label">User ID:</span> <span id="user_id" class="value"></span></p>
                </div>

                <div class="info-card">
                    <h3>ğŸ” JWT í† í° ì •ë³´</h3>
                    <p><span class="label">Subject (sub):</span> <span id="sub" class="value"></span></p>
                    <p><span class="label">Issuer (iss):</span> <span id="iss" class="value"></span></p>
                    <p><span class="label">Audience (aud):</span> <span id="aud" class="value"></span></p>
                    <p><span class="label">Expires At:</span> <span id="exp" class="value"></span></p>
                    <p><span class="label">Issued At:</span> <span id="iat" class="value"></span></p>
                    <p><span class="label">Scope:</span> <span id="scope" class="value"></span></p>
                </div>

                <div class="info-card">
                    <h3>âš¡ ì„¸ì…˜ ì •ë³´</h3>
                    <p><span class="label">ì¸ì¦ ìƒíƒœ:</span> <span id="authenticated" class="value"></span></p>
                    <p><span class="label">í† í° ì €ì¥ì†Œ:</span> <span class="value">localStorage</span></p>
                    <p><span class="label">í˜„ì¬ ì‹œê°„:</span> <span id="current_time" class="value"></span></p>
                </div>
            </div>

            <!-- SSO ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="navigation">
                <!-- SSO ê´€ë¦¬ ì„¹ì…˜ -->
                <div class="nav-card" onclick="location.href='/admin/sso/configurations'">
                    <div class="icon">ğŸ“‹</div>
                    <h3>SSO ì„¤ì • ëª©ë¡</h3>
                    <p>ë“±ë¡ëœ ëª¨ë“  SSO ì œê³µì ì„¤ì •ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="nav-card" onclick="location.href='/admin/sso/configurations/form'">
                    <div class="icon">â•</div>
                    <h3>ìƒˆ SSO ì„¤ì •</h3>
                    <p>SAML, OIDC, OAuth2 ë“± ìƒˆë¡œìš´ SSO ì œê³µìë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.</p>
                </div>

                <!-- ë¹ ë¥¸ SSO ì„¤ì • ì„¹ì…˜ -->
                <div class="nav-card" onclick="quickAddSAML()">
                    <div class="icon">ğŸ”</div>
                    <h3>SAML ë¹ ë¥¸ ì„¤ì •</h3>
                    <p>SAML 2.0 ì œê³µìë¥¼ ë¹ ë¥´ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="nav-card" onclick="quickAddOIDC()">
                    <div class="icon">ğŸ†”</div>
                    <h3>OIDC ë¹ ë¥¸ ì„¤ì •</h3>
                    <p>OpenID Connect ì œê³µìë¥¼ ë¹ ë¥´ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                </div>

                <!-- í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ì„¹ì…˜ -->
                <div class="nav-card" onclick="testAllConfigurations()">
                    <div class="icon">ğŸ”§</div>
                    <h3>ì „ì²´ SSO í…ŒìŠ¤íŠ¸</h3>
                    <p>ëª¨ë“  í™œì„±í™”ëœ SSO ì„¤ì •ì˜ ì—°ê²° ìƒíƒœë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
                </div>

            </div>

            <div class="stats-section">
                <h3>ğŸ“ˆ SSO í˜„í™© (ê°œë°œ ì˜ˆì •)</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="totalConfigurations">0</div>
                        <div class="label">ì´ SSO ì„¤ì • ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="activeConfigurations">0</div>
                        <div class="label">í™œì„± SSO ì„¤ì •</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="todayLogins">0</div>
                        <div class="label">ì˜¤ëŠ˜ SSO ë¡œê·¸ì¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="successRate">0%</div>
                        <div class="label">ë¡œê·¸ì¸ ì„±ê³µë¥ </div>
                    </div>
                </div>
            </div>

            <div class="claims-section">
                <h3>ğŸ“‹ ëª¨ë“  JWT í´ë ˆì„</h3>
                <table class="claims-table" id="claims_table">
                    <thead>
                        <tr>
                            <th>í´ë ˆì„ í‚¤</th>
                            <th>ê°’</th>
                            <th>íƒ€ì…</th>
                        </tr>
                    </thead>
                    <tbody id="claims_body">
                    </tbody>
                </table>
            </div>
        </div>

        <br/>
        <button id="logout_btn" class="logout-btn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <script>
        const idpClientId = "oauth2-client";
        const clientSecret = "secret";
        const redirectUri = "http://localhost:9001/admin/home";
        const authServerAuthorizeUrl = "http://localhost:9000/oauth2/authorize";
        const tokenUrl = "http://localhost:9000/oauth2/token";
        const adminHomeApiUrl = "http://localhost:9001/api/admin/home"; // API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
        const state = crypto.randomUUID();

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000); // 1ì´ˆë§ˆë‹¤ í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸

        async function fetchToken(code) {
            const body = new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                client_id: idpClientId,
                client_secret: clientSecret
            });

            try {
                const res = await fetch(tokenUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: body.toString()
                });

                if (!res.ok) throw new Error("Token exchange failed");

                const tokenResponse = await res.json();
                localStorage.setItem("access_token", tokenResponse.access_token);
                localStorage.setItem("refresh_token", tokenResponse.refresh_token);

                await fetchProtectedData();
            } catch (error) {
                setLoginStatus(false, "í† í° êµí™˜ ì‹¤íŒ¨: " + error.message);
            }
        }

        async function fetchProtectedData() {
            const token = localStorage.getItem("access_token");

            if (!token) {
                redirectToAuth();
                return;
            }

            try {
                const res = await fetch(adminHomeApiUrl, {
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });

                if (res.status === 401 || res.status === 403) {
                    localStorage.removeItem("access_token");
                    localStorage.removeItem("refresh_token");
                    redirectToAuth();
                    return;
                }

                const data = await res.json();
                
                if (data.authenticated) {
                    setLoginStatus(true, "ë¡œê·¸ì¸ ì„±ê³µ!");
                    populateUserInfo(data);
                    document.getElementById("content").style.display = "block";
                } else {
                    setLoginStatus(false, data.error || "ì¸ì¦ ì‹¤íŒ¨");
                }
            } catch (error) {
                setLoginStatus(false, "API í˜¸ì¶œ ì‹¤íŒ¨: " + error.message);
            }
        }

        function populateUserInfo(data) {
            // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´
            document.getElementById("username").textContent = data.username || 'N/A';
            document.getElementById("email").textContent = data.email || 'N/A';
            document.getElementById("name").textContent = data.name || 'N/A';
            document.getElementById("role").textContent = data.role || 'N/A';

            // Shopl ê³„ì • ì •ë³´
            document.getElementById("account_id").textContent = data.account_id || 'N/A';
            document.getElementById("shopl_client_id").textContent = data.shopl_client_id || 'N/A';
            document.getElementById("shopl_user_id").textContent = data.shopl_user_id || 'N/A';
            document.getElementById("user_id").textContent = data.user_id || 'N/A';

            // JWT í† í° ì •ë³´
            document.getElementById("sub").textContent = data.sub || 'N/A';
            document.getElementById("iss").textContent = data.iss || 'N/A';
            document.getElementById("aud").textContent = Array.isArray(data.aud) ? data.aud.join(', ') : (data.aud || 'N/A');
            document.getElementById("exp").textContent = data.exp ? formatTimestamp(data.exp) : 'N/A';
            document.getElementById("iat").textContent = data.iat ? formatTimestamp(data.iat) : 'N/A';
            document.getElementById("scope").textContent = data.scope || 'N/A';

            // ì„¸ì…˜ ì •ë³´
            document.getElementById("authenticated").textContent = data.authenticated ? 'âœ… ì¸ì¦ë¨' : 'âŒ ë¯¸ì¸ì¦';

            // ëª¨ë“  í´ë ˆì„ í…Œì´ë¸” ìƒì„±
            populateClaimsTable(data.all_claims || {});
        }

        function populateClaimsTable(claims) {
            const tbody = document.getElementById("claims_body");
            tbody.innerHTML = '';

            Object.entries(claims).forEach(([key, value]) => {
                const row = tbody.insertRow();
                row.insertCell(0).innerHTML = `<span class="claim-key">${key}</span>`;
                row.insertCell(1).innerHTML = `<span class="claim-value">${formatClaimValue(value)}</span>`;
                row.insertCell(2).textContent = typeof value;
            });
        }

        function formatClaimValue(value) {
            if (value === null || value === undefined) return 'N/A';
            if (typeof value === 'object') return JSON.stringify(value, null, 2);
            if (typeof value === 'string' && value.length > 100) return value.substring(0, 100) + '...';
            return String(value);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('ko-KR');
        }

        function updateCurrentTime() {
            document.getElementById("current_time").textContent = new Date().toLocaleString('ko-KR');
        }

        function setLoginStatus(success, message) {
            const statusEl = document.getElementById("login_status");
            statusEl.className = `status ${success ? 'success' : 'error'}`;
            statusEl.textContent = `${success ? 'âœ…' : 'âŒ'} ${message}`;
        }

        function redirectToAuth() {
            const params = new URLSearchParams({
                response_type: "code",
                client_id: idpClientId,
                redirect_uri: redirectUri,
                scope: "openid profile read write",
                state: state
            });

            window.location.href = `${authServerAuthorizeUrl}?${params.toString()}`;
        }

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            window.location.href = "http://localhost:9000/logout";
        }

        // SSO ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function showComingSoon() {
            alert('ğŸš§ ê°œë°œ ì˜ˆì •ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤!');
        }

        // ë¹ ë¥¸ SSO ì„¤ì • í•¨ìˆ˜ë“¤
        function quickAddSAML() {
            const url = '/admin/sso/configurations/form?type=SAML&quick=true';
            window.location.href = url;
        }

        function quickAddOIDC() {
            const url = '/admin/sso/configurations/form?type=OIDC&quick=true';
            window.location.href = url;
        }

        function quickAddOAuth2() {
            const url = '/admin/sso/configurations/form?type=OAUTH2&quick=true';
            window.location.href = url;
        }

        // í…ŒìŠ¤íŠ¸ ë° ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function testAllConfigurations() {
            const confirmTest = confirm('ğŸ”§ ëª¨ë“  í™œì„±í™”ëœ SSO ì„¤ì •ì˜ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ëª‡ ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

            if (!confirmTest) return;

            try {
                // í…ŒìŠ¤íŠ¸ ì§„í–‰ ì•Œë¦¼
                const progressModal = showProgressModal('SSO ì—°ê²° í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...', 0);

                // TODO: ì‹¤ì œ í…ŒìŠ¤íŠ¸ API í˜¸ì¶œ
                const testResults = await simulateAllSSOTest();

                hideProgressModal(progressModal);
                showTestResults(testResults);

            } catch (error) {
                alert('âŒ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function simulateAllSSOTest() {
            // ì‹œë®¬ë ˆì´ì…˜: 3ê°œì˜ SSO ì„¤ì • í…ŒìŠ¤íŠ¸
            const configs = ['Google Workspace', 'Microsoft Azure AD', 'Okta'];
            const results = [];

            for (let i = 0; i < configs.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                results.push({
                    name: configs[i],
                    success: Math.random() > 0.3, // 70% ì„±ê³µë¥ 
                    responseTime: Math.floor(Math.random() * 500) + 100
                });
            }

            return results;
        }

        function showTestResults(results) {
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;

            let message = `ğŸ”§ ì „ì²´ SSO í…ŒìŠ¤íŠ¸ ì™„ë£Œ\\n\\n`;
            message += `âœ… ì„±ê³µ: ${successCount}/${totalCount}\\n\\n`;

            results.forEach(result => {
                const status = result.success ? 'âœ…' : 'âŒ';
                message += `${status} ${result.name}: ${result.responseTime}ms\\n`;
            });

            alert(message);
        }

        function showProgressModal(message, progress) {
            // ê°„ë‹¨í•œ ì§„í–‰ë¥  í‘œì‹œ (ì‹¤ì œë¡œëŠ” ëª¨ë‹¬ êµ¬í˜„)
            console.log(`${message} ${progress}%`);
            return { message, progress };
        }

        function hideProgressModal(modal) {
            console.log('í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
        }

        // í†µê³„ ë° ê°€ì´ë“œ í•¨ìˆ˜ë“¤
        function showSSOUsageStats() {
            // TODO: ì‹¤ì œ í†µê³„ í˜ì´ì§€ë¡œ ì´ë™
            alert('ğŸ“Š SSO ì‚¬ìš© í†µê³„\\n\\nâ€¢ ì˜¤ëŠ˜ ë¡œê·¸ì¸: 147íšŒ\\nâ€¢ ì´ë²ˆ ì£¼ ì„±ê³µë¥ : 94.2%\\nâ€¢ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ì œê³µì: Google Workspace\\n\\nğŸš§ ìƒì„¸ í†µê³„ í˜ì´ì§€ëŠ” ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        function showSSOGuide() {
            const guides = [
                'ğŸ“– SSO ì„¤ì • ê°€ì´ë“œ',
                '',
                'ğŸ” SAML 2.0 ì„¤ì • ê°€ì´ë“œ',
                'â€¢ ë©”íƒ€ë°ì´í„° URL í™•ì¸ ë°©ë²•',
                'â€¢ ì†ì„± ë§¤í•‘ ì„¤ì •',
                'â€¢ ì¸ì¦ì„œ ê´€ë¦¬',
                '',
                'ğŸ†” OIDC ì„¤ì • ê°€ì´ë“œ',
                'â€¢ Discovery URL ì„¤ì •',
                'â€¢ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ ì„¤ì •',
                'â€¢ ìŠ¤ì½”í”„ ë° í´ë ˆì„ ë§¤í•‘',
                '',
                'ğŸ”‘ OAuth 2.0 ì„¤ì • ê°€ì´ë“œ',
                'â€¢ ì¸ì¦/í† í° ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •',
                'â€¢ ì‚¬ìš©ì ì •ë³´ API ì—°ë™',
                '',
                'ğŸš§ ìƒì„¸ ê°€ì´ë“œëŠ” ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.'
            ];

            alert(guides.join('\\n'));
        }

        // í†µê³„ ë°ì´í„° ë¡œë“œ (í–¥í›„ êµ¬í˜„)
        async function loadStatistics() {
            // TODO: ì‹¤ì œ APIì—ì„œ í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            document.getElementById('totalConfigurations').textContent = '0';
            document.getElementById('activeConfigurations').textContent = '0';
            document.getElementById('todayLogins').textContent = '0';
            document.getElementById('successRate').textContent = '0%';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("logout_btn").addEventListener("click", logout);

        // ì´ˆê¸° ì‹¤í–‰
        (async () => {
            // OAuth2 ë¡œê·¸ì¸ ì™„ë£Œ í›„ í† í° êµí™˜
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // Authorization Codeê°€ ìˆìœ¼ë©´ í† í° êµí™˜
                await fetchToken(code);
                // URL ì •ë¦¬ (code, state ì œê±°)
                window.history.replaceState({}, document.title, "/admin/home");
            } else {
                // ì½”ë“œê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ í† í°ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ
                await fetchProtectedData();
            }

            await loadStatistics();
        })();
    </script>
</body>
</html>
