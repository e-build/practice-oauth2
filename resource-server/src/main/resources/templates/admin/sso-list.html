<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>SSO ì„¤ì • ëª©ë¡ - Shopl B2B SaaS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { color: #007bff; margin: 0; }
        .header .breadcrumb { color: #6c757d; font-size: 14px; margin-top: 5px; }
        .header .breadcrumb a { color: #007bff; text-decoration: none; }
        .header .breadcrumb a:hover { text-decoration: underline; }
        .user-info { background: #e9f4ff; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff; margin-bottom: 20px; }
        .user-info .label { font-weight: bold; color: #495057; }
        .user-info .value { color: #6c757d; font-family: monospace; }
        .toolbar { display: flex; justify-content: between; align-items: center; margin-bottom: 20px; gap: 20px; }
        .toolbar .left { flex: 1; }
        .toolbar .right { flex-shrink: 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 14px; transition: all 0.3s ease; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #545b62; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .search-box { width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .table-container { background: white; border-radius: 6px; overflow: hidden; border: 1px solid #dee2e6; }
        .table { width: 100%; border-collapse: collapse; }
        .table thead th { background-color: #f8f9fa; padding: 12px; border-bottom: 2px solid #dee2e6; font-weight: bold; color: #495057; text-align: left; }
        .table tbody td { padding: 12px; border-bottom: 1px solid #dee2e6; }
        .table tbody tr:hover { background-color: #f8f9fa; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-inactive { background-color: #f8d7da; color: #721c24; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .provider-type { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .provider-saml { background-color: #e1f5fe; color: #01579b; }
        .provider-oidc { background-color: #f3e5f5; color: #4a148c; }
        .provider-oauth2 { background-color: #e8f5e8; color: #1b5e20; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .error-message { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
    </style>
    <script src="/js/auth.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ SSO ì„¤ì • ëª©ë¡</h1>
            <div class="breadcrumb">
                <a href="/admin/home">Shopl B2B SaaS > ê´€ë¦¬ì > ì¸ì¦ ê´€ë¦¬</a> > SSO ì„¤ì • ëª©ë¡
            </div>
        </div>

        <div class="user-info">
            <p><span class="label">ê´€ë¦¬ì:</span> <span class="value" id="username">ë¡œë”© ì¤‘...</span></p>
            <p><span class="label">íšŒì‚¬ ID:</span> <span class="value" id="companyId">ë¡œë”© ì¤‘...</span></p>
        </div>

        <div class="toolbar">
            <div class="left">
                <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” SSO ì„¤ì • ê²€ìƒ‰ (ì´ë¦„, ë„ë©”ì¸, ì œê³µì...)">
            </div>
            <div class="right">
                <button onclick="refreshList()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <a href="/admin/sso/configurations/form" class="btn btn-primary">â• ìƒˆ SSO ì¶”ê°€</a>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="loadingMessage" class="loading">
            ğŸ”„ SSO ì„¤ì • ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <div id="tableContainer" class="table-container" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>ì„¤ì • ì´ë¦„</th>
                        <th>ì œê³µì ìœ í˜•</th>
                        <th>íšŒì‚¬/ë„ë©”ì¸</th>
                        <th>ìƒíƒœ</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ë§ˆì§€ë§‰ ìˆ˜ì •</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="ssoTableBody">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="icon">ğŸ“‹</div>
            <h3>ë“±ë¡ëœ SSO ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìƒˆë¡œìš´ SSO ì œê³µìë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
            <a href="/admin/sso/configurations/form" class="btn btn-primary">â• ì²« ë²ˆì§¸ SSO ì¶”ê°€</a>
        </div>

        <div class="toolbar">
            <div class="left">
                <a href="/admin/home" class="btn btn-secondary">ğŸ  ê´€ë¦¬ì í™ˆ</a>
                <a href="/admin/home" class="btn btn-secondary">ğŸ“Š ê´€ë¦¬ì í™ˆ</a>
                <button onclick="quickAddSAML()" class="btn btn-success">ğŸ” SAML ë¹ ë¥¸ ì¶”ê°€</button>
                <button onclick="quickAddOIDC()" class="btn btn-success">ğŸ†” OIDC ë¹ ë¥¸ ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ëŠ” ëª¨ì˜ ë°ì´í„° ì‚¬ìš©, ë‚˜ì¤‘ì— ì‹¤ì œ APIë¡œ êµì²´ TODO: ë‹¹ì¥ ì‹¤ì œ API ë¡œ êµì²´ë°”ëŒ
        const mockSsoConfigurations = [
            {
                id: 1,
                name: "Google Workspace SSO",
                providerType: "OIDC",
                companyDomain: "example.com",
                status: "ACTIVE",
                createdAt: "2024-01-15T10:30:00Z",
                updatedAt: "2024-01-20T14:45:00Z"
            },
            {
                id: 2,
                name: "Microsoft Azure AD",
                providerType: "SAML",
                companyDomain: "corp.example.com",
                status: "ACTIVE",
                createdAt: "2024-01-10T09:15:00Z",
                updatedAt: "2024-01-18T16:20:00Z"
            },
            {
                id: 3,
                name: "Okta SSO",
                providerType: "SAML",
                companyDomain: "startup.com",
                status: "PENDING",
                createdAt: "2024-01-25T11:00:00Z",
                updatedAt: "2024-01-25T11:00:00Z"
            }
        ];

        async function loadSsoConfigurations() {
            try {
                // ì‹¤ì œ API í˜¸ì¶œ
                const configurations = await Auth.get('/api/admin/sso/configurations');
                displaySsoConfigurations(configurations);

            } catch (error) {
                console.error('SSO ì„¤ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ì‹œ ëª¨ì˜ ë°ì´í„° ì‚¬ìš©
                await new Promise(resolve => setTimeout(resolve, 500));
                displaySsoConfigurations(mockSsoConfigurations);
            }
        }

        function displaySsoConfigurations(configurations) {
            const loadingEl = document.getElementById('loadingMessage');
            const tableEl = document.getElementById('tableContainer');
            const emptyEl = document.getElementById('emptyState');
            const tbody = document.getElementById('ssoTableBody');

            loadingEl.style.display = 'none';

            if (configurations.length === 0) {
                emptyEl.style.display = 'block';
                tableEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            tableEl.style.display = 'block';

            tbody.innerHTML = configurations.map(config => `
                <tr>
                    <td><strong>${config.name}</strong></td>
                    <td><span class="provider-type provider-${config.providerType.toLowerCase()}">${config.providerType}</span></td>
                    <td>${extractCompanyDomain(config)}</td>
                    <td><span class="status-badge status-${config.status.toLowerCase()}">${getStatusText(config.status)}</span></td>
                    <td>${formatDate(config.createdAt)}</td>
                    <td>${formatDate(config.updatedAt)}</td>
                    <td>
                        <button onclick="editConfiguration('${config.id}')" class="btn btn-sm btn-primary">âœï¸ í¸ì§‘</button>
                        <button onclick="testConfiguration('${config.id}')" class="btn btn-sm btn-success">ğŸ”§ í…ŒìŠ¤íŠ¸</button>
                        <button onclick="deleteConfiguration('${config.id}')" class="btn btn-sm btn-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'ACTIVE': 'í™œì„±',
                'INACTIVE': 'ë¹„í™œì„±',
                'PENDING': 'ëŒ€ê¸°ì¤‘'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            const loadingEl = document.getElementById('loadingMessage');

            loadingEl.style.display = 'none';
            errorEl.textContent = 'âŒ ' + message;
            errorEl.style.display = 'block';
        }

        function refreshList() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            loadSsoConfigurations();
        }

        function editConfiguration(id) {
            window.location.href = `/admin/sso/configurations/form?id=${id}`;
        }

        function testConfiguration(id) {
            alert(`ğŸ”§ SSO ì„¤ì • ${id} í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì€ ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.`);
        }

        function deleteConfiguration(id) {
            if (confirm('ì •ë§ë¡œ ì´ SSO ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert(`ğŸ—‘ï¸ SSO ì„¤ì • ${id} ì‚­ì œ ê¸°ëŠ¥ì€ ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.`);
            }
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#ssoTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // íšŒì‚¬/ë„ë©”ì¸ ì •ë³´ ì¶”ì¶œ í•¨ìˆ˜
        function extractCompanyDomain(config) {
            if (config.details) {
                // OIDCì˜ ê²½ìš° issuerì—ì„œ ë„ë©”ì¸ ì¶”ì¶œ
                if (config.details.issuer) {
                    try {
                        const url = new URL(config.details.issuer);
                        return url.hostname;
                    } catch (e) {
                        return config.details.issuer;
                    }
                }
                // SAMLì˜ ê²½ìš° entityIdì—ì„œ ë„ë©”ì¸ ì¶”ì¶œ
                if (config.details.entityId) {
                    try {
                        const url = new URL(config.details.entityId);
                        return url.hostname;
                    } catch (e) {
                        // URLì´ ì•„ë‹Œ ê²½ìš° entityId ìì²´ ë°˜í™˜
                        return config.details.entityId;
                    }
                }
                // clientIdê°€ ìˆëŠ” ê²½ìš°
                if (config.details.clientId) {
                    return config.details.clientId;
                }
            }
            return 'N/A';
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const userInfo = await Auth.get('/api/admin/user-info');
                if (userInfo.authenticated) {
                    document.getElementById('username').textContent = userInfo.username || 'Unknown';
                    document.getElementById('companyId').textContent = userInfo.accountId || 'Unknown';
                } else {
                    document.getElementById('username').textContent = 'anonymous';
                    document.getElementById('companyId').textContent = 'unknown';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('username').textContent = 'anonymous';
                document.getElementById('companyId').textContent = 'unknown';
            }
        }

        // ê¶Œí•œ í™•ì¸ í›„ ë°ì´í„° ë¡œë“œ
        async function checkPermissionAndLoad() {
            try {
                await Auth.initPageAuth('/api/admin/check-permission', '/admin/home');
                await loadUserInfo();
                await loadSsoConfigurations();
            } catch (error) {
                console.error('ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                showError('ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¹ ë¥¸ ì„¤ì • í•¨ìˆ˜ë“¤
        function quickAddSAML() {
            const url = '/admin/sso/configurations/form?type=SAML&quick=true';
            window.location.href = url;
        }

        function quickAddOIDC() {
            const url = '/admin/sso/configurations/form?type=OIDC&quick=true';
            window.location.href = url;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', checkPermissionAndLoad);
    </script>
</body>
</html>